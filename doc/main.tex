\documentclass{article}
\usepackage{fullpage}

%load needed packages
\usepackage{graphicx}
\usepackage{array}
\usepackage{booktabs}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\usepackage[spanish]{babel} % Paquete para el idioma español
\usepackage{float}  % Necesario para [H]
\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{HTML}{5AB2FF}
\definecolor{morado}{HTML}{AD88C6}
\definecolor{BG}{HTML}{EEEEEE}
\definecolor{azul}{HTML}{4D869C}
\definecolor{sqlblue}{HTML}{FF8C00} % Color para las palabras clave SQL

% Estilo para DDL
\lstdefinestyle{ddlstyle}{
	language=SQL,
	backgroundcolor=\color{BG},
	commentstyle=\color{codegreen},
	basicstyle=\ttfamily\small,
	keywordstyle=\color{azul},
	stringstyle=\color{morado},
	showstringspaces=false,
	breaklines=true,
	frame=shadowbox,
	numbers=left,
	numberstyle=\tiny\color{gray},
	captionpos=b,
}

% Estilo para SQL
\lstdefinestyle{sqlstyle}{
	language=SQL,
	backgroundcolor=\color{BG},
	commentstyle=\color{codegreen},
	basicstyle=\ttfamily\small,
	keywordstyle=\color{sqlblue}, % Color diferente para palabras clave SQL
	stringstyle=\color{morado},
	showstringspaces=false,
	breaklines=true,
	frame=shadowbox,
	numbers=left,
	numberstyle=\tiny\color{gray},
	captionpos=b,
}

\begin{document}



% Portada
\begin{titlepage}
	\centering
	\vspace*{3cm}
	
	% Título destacado
	{\Huge \textbf{Practica 1: Bases De Datos Relacionales}\\[0.5cm]}
	
	% Espacio y logotipo (si lo tienes, por ejemplo el logo de tu universidad)
	\vspace{2cm}
	\includegraphics[width=0.3\textwidth]{images/uma_logo.jpg}\\[1cm]
	
	% Nombre del autor
	{\LARGE \textbf{Alejandro Silva Rodríguez}\\[0.5cm]}
	{\LARGE \textbf{Marta Cuevas Rodríguez}\\[0.5cm]}
	{\large \textit{Almacenes De Datos}\\
		Universidad de Málaga\\
		}
	
	\vfill
	
	% Fecha en la parte inferior de la página
	{\large Septiembre 2024}
\end{titlepage}

% indice
\tableofcontents

\newpage

\section{Introducción}

En esta práctica, se diseñará y creará una base de datos para gestionar información sobre parques naturales en Andalucía y la liga española de fútbol de primera división. El objetivo es elaborar un modelo entidad-relación y un modelo relacional que muestren las características y relaciones de las entidades involucradas, utilizando herramientas de diseño de bases de datos.

Además, se generará el DDL (Data Definition Language) para SQL Server, que permitirá crear la base de datos y las tablas necesarias. Se incluirán datos sobre los parques naturales, su gestión y las especies que los habitan, así como información sobre los equipos de fútbol, sus jugadores y los partidos.

Este ejercicio ayudará a aplicar los conceptos de bases de datos y ofrecerá una experiencia práctica en el uso de herramientas y lenguajes de consulta.



\section{Parques Naturales}

En esta sección se explicara como se diseñó e implementó la base de datos de parques naturales y las consultas sobre la misma.

\subsection{Requisitos De Datos}

La Junta de Andalucía desea mantener la información sobre los parques naturales que hay en su comunidad autónoma. En particular sería necesario conocer el nombre del parque (que es único), su teléfono, dirección administrativa, una dirección web, un correo electrónico, su fecha de declaración como parque natural, la extensión (en hectáreas) de cada zona protegida, las especies animales que contiene, la población estimada de cada una de ellas y la dirección gestora del parque. Esta dirección gestora del parque está coordinada por un presidente y un número no determinado de consejeros. De todos estos miembros de la dirección gestora se desea conocer el DNI, nombre, fecha de nacimiento, dirección y teléfono de cada uno de ellos. Cada persona puede ser a lo sumo consejero en un parque y presidente de otro. De las especies guardamos su nombre científico y el común (ambos son únicos), el número de años de vida media. 
\\

Con objeto de poder determinar el estado de salud del parque necesitamos información sobre la interacción del hombre con el entorno. Para ello se almacenan datos sobre los municipios donde está ubicado el parque: número de municipios que abarca, nombre de cada uno de ellos, enlace a su web, fichero con la foto de su escudo, partido que gobierna en la alcaldía, número de habitantes y gasto de agua medio por habitante. 
\\

Las especies tienen una extensión (en hectáreas) necesaria para desarrollarse en libertad, dato que aparece en los estudios generales sobre cada especie. Sin embargo, el dato de si la especie está superpoblada en cada parque se guardará explícitamente, porque puede depender de factores como si el parque es montañoso, si tiene acuíferos, etc y por tanto precisa de la opinión última de un experto. Tenga en cuenta que cada municipio abarca a lo sumo un sólo parque. 

\newpage
\subsection{Diseño Lógico}

Para crear el diseño lógico de la base de datos en Oracle Datamodeler \cite{oracle2024} empezaremos representando las figuras más relevantes como entidades, entre ellas encontramos a especie animal, municipio, parque natural y persona (figura \ref{fig:p_logico}). Cada entidad tendrá atributos que solo pertenecen a ella y no se relacionan con ninguna entidad más excepto del atributo numero de municipios que abarca de un parque natural, tendrá que ir actualizandose mediante un trigger cada vez que se le añade o elimina una relación municipio.Tambien tendremos una entidad intermedia entre especie animal y parque natural que almacenará la relacion entre estas y los atributos extensión, población estimada y is\_superpoblado (booleano).
\\

Por ultimo, tenemos relaciones entre parque natural y municipio y dos entre parque natural y persona. Una relación 1:N representará los consejeros del parque natural y otra 1:1 representara el presidente del parque.

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{images/diagrama_logico_parques_naturales.png}
	\caption{Diagrama Lógico De Parques Naturales}
	\label{fig:p_logico}
\end{figure}

\newpage

\subsection{Diseño Entidad Relación}

En el diseño entidad relación tenemos que tener en cuenta que las claves y restricciones están donde se necesitan para poder hacer consultas en la base de datos. Observamos (figura \ref{fig:p_relacional}) que parque natural tiene una clave foranea dni que representa al unico presidente de esta entidad, mientras que persona tiene una clave foranea nombre de parque natural que relaciona a los consejeros con esta. Municipio obtiene la clave foranea de parque natural debido a su particion en la parte N de la relación. La entidad intermedia de especie animal y parque natural obtiene sus dos claves foraneas que pasan a ser su clave principal.

\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{images/diagrama_relacional_parques_naturales.png}
	\caption{Diagrama Relacional De Parques Naturales}
	\label{fig:p_relacional}
\end{figure}

\subsection{Implementación}

En la implementación de la base de datos generaremos el ddl (data definition languaje) de la base de datos e insertaremos tuplas en la misma. En el listing \ref{fig:p_ddl} encontramos una pequeña parte del mismo donde se crea la tabla de especie animal. Esto se ejecutará en Microsoft SQL Server \cite{sqlserver2022} donde se alojará la base de datos.
\begin{lstlisting}[style=ddlstyle, label=fig:p_ddl,caption=Definicion De Datos De Parques Naturales]
	
	CREATE TABLE ESPECIE_ANIMAL 
	(
	nombre_cientifico VARCHAR (30) NOT NULL , 
	nombre_comun VARCHAR (30) , 
	esperanza_vida NUMERIC (28) 
	)
	GO
	
	ALTER TABLE ESPECIE_ANIMAL ADD CONSTRAINT ESPECIE_ANIMAL_PK PRIMARY KEY CLUSTERED (nombre_cientifico)
	WITH (
	ALLOW_PAGE_LOCKS = ON , 
	ALLOW_ROW_LOCKS = ON )
	GO
	
	
\end{lstlisting}
\newpage

En el listing \ref{fig:p_insert} se observan ejemplos de las inserciones que se hacen sobre la base de datos y el trigger que añadimos para la actualización del número de municipios. Es crucial seguir un orden logico a la hora de la inserción ya que algunas entidades dependen de otras.
\begin{lstlisting}[style=sqlstyle, label=fig:p_insert,caption=Carga de datos]
	-- Insertar especies animales
	INSERT INTO ESPECIE_ANIMAL (nombre_cientifico, nombre_comun, esperanza_vida) VALUES
	('Ursus arctos', 'Oso pardo', 25),
	-- Insertar personas (presidentes) - un presidente por parque natural
	INSERT INTO PERSONA (dni, nombre, direccion, fecha_nacimiento) VALUES
	('34567890C', 'Luis Torres', 'Calle Larga 789', '1985-02-20'),  -- Cabo de Gata
	-- Insertar parques naturales
	INSERT INTO PARQUE_NATURAL (nombre, telefono, direccion_administrativa, direccion_web, correo_electronico, fecha_de_declaracion, numero_municipios_que_abarca, PERSONA_dni) VALUES
	('Sierra Nevada', 123456789, 'Granada', 'www.sierranevada.com', 
	('Picos de Europa', 321321321, 'Asturias', 'www.picosdeeuropa.com', 'contacto@picos.com', '1999-10-05', 0, '45678901D');
	-- Insertar consejeros
	INSERT INTO PERSONA (dni, nombre, direccion, fecha_nacimiento, PARQUE_NATURAL_nombre) VALUES
	('23456789K', 'Valeria Torres', 'Avenida Costa 234', '1988-09-17', 'Cabo de Gata'),
	go
	-- Actualizar el numero de municipios del parque al insertar un municipio al que pertenece
	CREATE TRIGGER actualizar_numero_municipios_insert
	ON MUNICIPIO
	AFTER INSERT
	AS
	BEGIN
	-- Sumar 1 a cada parque natural por cada municipio insertado
	UPDATE PN
	SET PN.numero_municipios_que_abarca = PN.numero_municipios_que_abarca + (
	SELECT COUNT(*)
	FROM inserted I
	WHERE I.PARQUE_NATURAL_nombre = PN.nombre
	)
	FROM PARQUE_NATURAL PN
	WHERE EXISTS (
	SELECT 1 FROM inserted I WHERE I.PARQUE_NATURAL_nombre = PN.nombre
	);
	END;
	GO
	-- Insertar municipios
	INSERT INTO MUNICIPIO (nombre, direccion_web, foto_escudo, partido_gobernante, gasto_agua_por_habitante, PARQUE_NATURAL_nombre) VALUES
	('Granada', 'www.granada.es', NULL, 'PSOE', 50.25, 'Sierra Nevada'),
	-- Insertar especies en parques
	INSERT INTO PARQUE_ESPECIE (extension, poblacion_estimada, is_superpoblado, PARQUE_NATURAL_nombre, ESPECIE_ANIMAL_nombre_cientifico) VALUES
	(10000, 200, 0, 'Sierra Nevada', 'Ursus arctos'),
\end{lstlisting}
\subsection{Consultas}

Para probar el correcto funcionamiento de la base de datos realizaremos consultas (listing \ref{fig:p_consultas}) que involucren varias tablas.
\begin{lstlisting}[style=sqlstyle, label=fig:p_consultas,caption=Consultas Sobre Parques Naturales]
	
	-- Consulta 1: Seleccionar los animales que se pueden encontrar en Sierra Nevada
	SELECT e.nombre_cientifico, e.nombre_comun, p.nombre
	FROM PARQUE_NATURAL p , PARQUE_ESPECIE pe, ESPECIE_ANIMAL e
	WHERE e.nombre_cientifico=pe.ESPECIE_ANIMAL_nombre_cientifico and pe.PARQUE_NATURAL_nombre=p.nombre and p.nombre='Sierra Nevada';
	
	-- Consulta 2: Seleccionar el nombre de los consejeros de Doñana
	
	SELECT p.nombre, c.nombre
	FROM PARQUE_NATURAL p, PERSONA c
	WHERE c.PARQUE_NATURAL_nombre=p.nombre and p.nombre='Doñana';
	
	-- Consulta 3: Seleccionar el nombre del presidente de Doñana
	
	SELECT p.nombre, c.nombre
	FROM PARQUE_NATURAL p, PERSONA c
	WHERE c.dni=p.PERSONA_dni and p.nombre='Doñana';
	
	-- Consulta 4: Seleccionar el nombre de los municipios que abarca doñana junto al numero de municipios que abarca
	
	SELECT m.nombre, p.nombre, p.numero_municipios_que_abarca
	FROM PARQUE_NATURAL p, MUNICIPIO m
	WHERE p.nombre=m.PARQUE_NATURAL_nombre and p.nombre='Doñana';
	
	-- Consulta 5: Seleccionar el nombre de los presidentes de paruqes en los que se encuentra algun tipo de oso
	
	SELECT e.nombre_comun, presi.nombre, p.nombre
	FROM PERSONA presi, ESPECIE_ANIMAL e, PARQUE_NATURAL p, PARQUE_ESPECIE pe
	WHERE presi.dni=p.PERSONA_dni and p.nombre=pe.PARQUE_NATURAL_nombre and pe.ESPECIE_ANIMAL_nombre_cientifico=e.nombre_cientifico and e.nombre_comun LIKE 'Oso%';
  \end{lstlisting}

\newpage
\section{Liga De Futbol}

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

\section{Acceso al Repositorio}

Toda la información adicional, incluyendo el código fuente y la documentación completa de este proyecto, está disponible en el repositorio de GitHub \cite{silva2024github}.

% Incluir la bibliografía
\bibliographystyle{plain}  % Estilo de la bibliografía (por ejemplo, plain, alpha, ieee, etc.)
\bibliography{bibli}  % Nombre del archivo .bib sin la extensión

\end{document}
